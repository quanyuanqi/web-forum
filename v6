from fasthtml.common import *
from time import time
from passlib.context import CryptContext
from functools import wraps

# Add styles for thread title links and auth-related elements
Style('''
.thread-title {
    color: #0066cc;
}
.thread-title:visited {
    color: #666666;
}
.auth-links {
    float: right;
    margin: 10px;
}
.auth-links a {
    margin-left: 10px;
    text-decoration: none;
    color: #0066cc;
}
.mw-480 {
    max-width: 480px;
}
.mx-auto {
    margin-left: auto;
    margin-right: auto;
}
''')

# Password hashing setup
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def render(thread, session=None):
    tid = f'thread-{thread.id}'
    edit_delete_controls = ''
    
    # Only show edit/delete controls if user is authenticated and is the author
    if session and 'auth' in session and hasattr(thread, 'author') and thread.author == session['auth']:
        edit_delete_controls = Div(
            A('Edit', hx_get=f'/edit/{thread.id}', hx_target='body',
              style='margin-right: 10px;'),
            A('Delete', hx_delete=f'/delete/{thread.id}',
              hx_target=f'#{tid}', hx_swap='outerHTML',
              style='color: red;',
              onclick="return confirm('Are you sure you want to delete this thread?')"
            ),
            style='margin-bottom: 10px;'
        )

    # Get username for display
    author_email = thread.email or "Anonymous"
    try:
        if thread.email:
            author = users[thread.email]
            author_display = getattr(author, 'username', author.email)  # Fallback to email if no username
        else:
            author_display = "Anonymous"
    except NotFoundError:
        author_display = author_email

    return Li(H4(A(thread.title, 
                   hx_get=f'/thread/{thread.id}',
                   hx_target='body',
                   style='text-decoration: none; cursor: pointer;',
                   class_='thread-title')),
             P(thread.content),
             P(f'Posted by: {author_display}'),
             edit_delete_controls,
             P(f'Posted: {format_time(thread.created_at)}'),
             id=tid,
             class_='thread-item')

# Database setup
app, rt, threads, Thread = fast_app('forum.db', live=True, render=render,
                                  id=int, title=str, content=str, 
                                  created_at=float, email=str, author=str, pk='id')

# User database setup
db = database('users.db')  # Changed path to current directory
users = db.t.users

if users not in db.t:
    users.create(dict(email=str, password=str, username=str), pk='email')
    
User = users.dataclass()

def format_time(timestamp):
    if not timestamp:
        return 'Unknown time'
    from datetime import datetime
    return datetime.fromtimestamp(timestamp).strftime('%Y-%m-%d %H:%M:%S')

# Authentication decorator
def basic_auth(f):
    @wraps(f)
    def wrapper(session, *args, **kwargs):
        if "auth" not in session:
            return Response('Not Authorized - Please login first', status_code=401)
        return f(session, *args, **kwargs)
    return wrapper

def auth_header():
    return Div(
        A('Login', href='/login'),
        A('Register', href='/register'),
        class_='auth-links'
    )

def mk_form(session):
    if 'auth' not in session:
        return P("Please login to post threads")
        
    return Form(
        Group(
            Input(placeholder='Thread title', id='title', required=True),
            Input(placeholder='Thread content', id='content', required=True,
                 style='height: 100px; width: 100%;'),
            Button('Post Thread')
        ),
        hx_post = '/',
        hx_target = '#thread-list',
        hx_swap = 'afterbegin'
    )

def mk_edit_form(thread):
    return Div(
        A('← Back to Home', hx_get='/', hx_target='body', 
          style='display: block; margin-bottom: 20px; text-decoration: none;'),
        Form(
            Group(
                Label('Title:'),
                Input(name='title', required=True, value=thread.title,
                     style='width: 100%; margin-bottom: 10px;'),
                Label('Content:'),
                Input(name='content', required=True,
                     value=thread.content,
                     style='height: 100px; width: 100%; margin-bottom: 10px;'),
                Div(
                    Button('Save Changes', style='margin-right: 10px;'),
                    A('Cancel', hx_get='/', hx_target='body', class_='cancel-link'),
                    style='margin-top: 10px;'
                )
            ),
            hx_post = f'/edit/{thread.id}',
            hx_target = 'body'
        )
    )

# Login and Register form helper
def auth_form(btn_text, target, include_username=False):
    inputs = []
    if include_username:
        inputs.append(Input(id="username", type="text", placeholder="Username", required=True))
    inputs.extend([
        Input(id="email", type="email", placeholder="Email", required=True),
        Input(id="password", type="password", placeholder="Password", required=True),
        Button(btn_text, type="submit"),
        Span(id="error", style="color:red")
    ])
    return Form(
        *inputs,
        hx_post=target,
        hx_target="#error",
    )

# Login routes
@rt('/login')
def get():
    return Container(
        Article(
            A('← Back to Home', hx_get='/', hx_target='body', 
              style='display: block; margin-bottom: 20px; text-decoration: none;'),
            H1("Login"),
            auth_form("Login", target="/login"),
            Hr(),
            P("Want to create an Account? ", A("Register", href="/register")),
            class_="mw-480 mx-auto"
        )
    )

@rt('/login')
def post(session, email:str, password:str):
    try:
        user = users[email]
    except NotFoundError:
        return "Email or password are incorrect"
    
    if not pwd_context.verify(password, user.password):
        return "Email or password are incorrect"

    session['auth'] = user.email
    
    return HttpHeader('HX-Redirect', '/')

# Register routes
@rt('/register')
def get():
    return Container(
        Article(
            A('← Back to Home', hx_get='/', hx_target='body', 
              style='display: block; margin-bottom: 20px; text-decoration: none;'),
            H1("Register"),
            auth_form("Register", "/register", include_username=True),
            Hr(),
            P("Already have an account? ", A("Login", href="/login")),
            class_="mw-480 mx-auto"
        )
    )

@rt('/register')
def post(email:str, password:str, username:str):
    if not username or len(username.strip()) < 3:
        return "Username must be at least 3 characters long"
        
    try:
        users[email]
        return "User already exists"
    except NotFoundError:
        new_user = User(email=email, password=pwd_context.hash(password), username=username)
        users.insert(new_user)
        return HttpHeader('HX-Redirect', '/login')

# Logout route
@rt('/logout')
def post(session):
    if 'auth' in session:
        del session['auth']
    return HttpHeader('HX-Redirect', '/login')

def get_thread_stats():
    from datetime import datetime, timedelta
    
    now = datetime.now()
    today_start = datetime(now.year, now.month, now.day).timestamp()
    week_ago = (now - timedelta(days=7)).timestamp()
    month_ago = (now - timedelta(days=30)).timestamp()
    
    all_threads = threads()
    today_count = 0
    week_count = 0
    month_count = 0
    
    for thread in all_threads:
        created_at = thread.created_at or 0
        if created_at >= today_start:
            today_count += 1
            week_count += 1
            month_count += 1
        elif created_at >= week_ago:
            week_count += 1
            month_count += 1
        elif created_at >= month_ago:
            month_count += 1
    
    return today_count, week_count, month_count

def render_stats():
    today_count, week_count, month_count = get_thread_stats()
    
    return Article(
        H2("Forum Statistics", style="text-align: center;"),
        Div(
            Article(
                H3(str(today_count)),
                P("New threads today"),
                style="text-align: center; padding: 20px;"
            ),
            Article(
                H3(str(week_count)),
                P("New threads this week"),
                style="text-align: center; padding: 20px;"
            ),
            Article(
                H3(str(month_count)),
                P("New threads this month"),
                style="text-align: center; padding: 20px;"
            ),
            style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;"
        ),
        P(
            "Please ", 
            A("login", href="/login"), 
            " or ",
            A("register", href="/register"),
            " to view and participate in discussions.",
            style="text-align: center; margin-top: 20px;"
        )
    )

@rt('/')
def get(session):
    # Show different content based on auth status
    if 'auth' not in session:
        return Titled('Forum',
                     auth_header(),
                     render_stats())
    
    # Get latest 20 threads, handling None created_at values
    all_threads = threads()
    # Set a default timestamp for threads without created_at
    for thread in all_threads:
        if thread.created_at is None:
            thread.created_at = 0
    latest_threads = sorted(all_threads, 
                          key=lambda t: t.created_at or 0,
                          reverse=True)[:20]
    
    # Show header with username
    try:
        user = users[session['auth']]
        username = getattr(user, 'username', user.email)
    except NotFoundError:
        username = session['auth']
        
    header = Div(
        Span(f"Welcome, {username}", style="margin-right: 10px;"),
        Button("Logout", hx_post="/logout", style="color: red;"),
        class_="auth-links"
    )
    
    return Titled('Forum',
                 header,
                 Card(
                     mk_form(session),
                     Ul(*[render(t, session) for t in latest_threads], id='thread-list', class_='thread-list')
                 ))

@rt('/')
@basic_auth
def post(session, thread: Thread):
    user_email = session['auth']
    thread.created_at = time()
    thread.email = user_email
    thread.author = user_email
    new_thread = threads.insert(thread)
    return render(new_thread, session)

@rt('/edit/{tid}')
@basic_auth
def get(session, tid: int):
    thread = threads[tid]
    if thread.author != session['auth']:
        return Response('Not authorized to edit this thread', status_code=403)
    return Titled('Edit Thread',
                 Card(mk_edit_form(thread)))

@rt('/edit/{tid}')
@basic_auth
def post(session, tid: int, thread: Thread):
    existing = threads[tid]
    if existing.author != session['auth']:
        return Response('Not authorized to edit this thread', status_code=403)
    existing.title = thread.title
    existing.content = thread.content
    threads.update(existing)
    return Redirect('/')

@rt('/delete/{tid}')
@basic_auth
def delete(session, tid: int):
    thread = threads[tid]
    if thread.author != session['auth']:
        return Response('Not authorized to delete this thread', status_code=403)
    threads.delete(tid)
    return ''

@rt('/thread/{tid}')
def get(session, tid: int):
    thread = threads[tid]
    
    # Get username for display
    try:
        if thread.email:
            author = users[thread.email]
            author_display = getattr(author, 'username', 'Anonymous')
        else:
            author_display = "Anonymous"
    except NotFoundError:
        author_display = "Anonymous"
    
    return Titled(thread.title,
                 Card(
                     A('← Back to Home', hx_get='/', hx_target='body',
                       style='display: block; margin-bottom: 20px; text-decoration: none;'),
                     H2(thread.title),
                     P(thread.content, style='margin: 20px 0;'),
                     Div(
                         Span(f'Posted by {author_display}'),
                         Span(' • '),
                         Span(format_time(thread.created_at)),
                         style='color: #666; margin-bottom: 20px;'
                     ),
                     render_thread_controls(thread, session) if session and 'auth' in session else ''
                 ))

def render_thread_controls(thread, session):
    if session and 'auth' in session and hasattr(thread, 'author') and thread.author == session['auth']:
        return Div(
            A('Edit', hx_get=f'/edit/{thread.id}', hx_target='body',
              style='margin-right: 10px;'),
            A('Delete', hx_delete=f'/delete/{thread.id}',
              hx_target='body', hx_swap='outerHTML',
              style='color: red;',
              onclick="return confirm('Are you sure you want to delete this thread?')"
            )
        )
    return ''

serve()
